name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [master, main]
    paths:
      - 'src/api/**'
      - 'Dockerfile'
      - 'requirements-api.txt'
      - 'metrics.json'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install huggingface_hub dvc[s3]

      - name: Configure DVC with DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify dagshub --local auth basic
          dvc remote modify dagshub --local user Alimiji
          dvc remote modify dagshub --local password $DAGSHUB_TOKEN

      - name: Pull model from DVC
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc pull models/random_forest/Production/model.pkl.dvc -v || true
          dvc pull models/random_forest/Production/model_info.json.dvc -v || true

          # Fallback to direct download if DVC fails
          if [ ! -f "models/random_forest/Production/model.pkl" ]; then
            echo "DVC pull failed, downloading directly from DagsHub..."
            mkdir -p models/random_forest/Production
            curl -u "Alimiji:$DAGSHUB_TOKEN" \
              -o models/random_forest/Production/model.pkl \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/44/bebd223b998cf7e177aed1e73de3a6"
            curl -u "Alimiji:$DAGSHUB_TOKEN" \
              -o models/random_forest/Production/model_info.json \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/00/6851e7426c173879e57b2b91201121"
          fi

      - name: Verify model exists
        run: |
          if [ ! -f "models/random_forest/Production/model.pkl" ]; then
            echo "ERROR: Model not found!"
            exit 1
          fi
          echo "Model size: $(du -h models/random_forest/Production/model.pkl)"

      - name: Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'EOF'
          import os
          from huggingface_hub import HfApi, create_repo

          token = os.environ.get('HF_TOKEN')
          repo_id = 'Alimiji/weather-prediction-api'

          api = HfApi()

          # Verify token
          try:
              user = api.whoami(token=token)
              print(f"Authenticated as: {user['name']}")
          except Exception as e:
              print(f"Auth error: {e}")
              exit(1)

          # Create Space if needed
          try:
              create_repo(
                  repo_id=repo_id,
                  repo_type='space',
                  space_sdk='docker',
                  token=token,
                  exist_ok=True,
                  private=False
              )
              print(f"Space {repo_id} ready")
          except Exception as e:
              print(f"Create repo error: {e}")

          # Create README with HF metadata
          readme_content = """---
          title: Weather Prediction API
          emoji: ðŸŒ¡ï¸
          colorFrom: blue
          colorTo: green
          sdk: docker
          pinned: false
          license: mit
          ---

          # Weather Temperature Prediction API

          FastAPI ML API for temperature prediction.

          ## Endpoints
          - GET /health - Health check
          - POST /predict - Make prediction
          - GET /docs - API documentation
          """

          with open('README.md', 'w') as f:
              f.write(readme_content.strip())

          # Upload files
          print("Uploading to HF Space...")
          try:
              api.upload_folder(
                  folder_path='.',
                  repo_id=repo_id,
                  repo_type='space',
                  token=token,
                  ignore_patterns=[
                      '.git*', '__pycache__', '*.pyc', '.env',
                      'mlruns/*', 'data/*', 'docs/*', '.dvc/*',
                      'tests/*', 'notebooks/*', 'streamlit_app/*',
                      '*.dvc', '.venv/*'
                  ]
              )
              print("Upload complete!")
              print(f"Space URL: https://huggingface.co/spaces/{repo_id}")
          except Exception as e:
              print(f"Upload error: {e}")
              exit(1)
          EOF

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to Hugging Face Spaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Space URL:** https://huggingface.co/spaces/Alimiji/weather-prediction-api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** https://alimiji-weather-prediction-api.hf.space" >> $GITHUB_STEP_SUMMARY
