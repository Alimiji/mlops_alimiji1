name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [master, main]
    paths:
      - 'src/api/**'
      - 'Dockerfile'
      - 'requirements-api.txt'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install huggingface_hub dvc[s3]

      - name: Configure DVC with DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify origin --local auth basic
          dvc remote modify origin --local user Alimiji
          dvc remote modify origin --local password $DAGSHUB_TOKEN

      - name: Pull model from DVC
        run: |
          dvc pull models/random_forest/Production/model.pkl.dvc -v || echo "DVC pull failed, trying direct download"
          dvc pull models/random_forest/Production/model_info.json.dvc -v || true
          # Verify model exists
          if [ -f "models/random_forest/Production/model.pkl" ]; then
            echo "Model downloaded successfully"
            ls -la models/random_forest/Production/
          else
            echo "Model not found, downloading from DagsHub directly..."
            mkdir -p models/random_forest/Production
            curl -u "Alimiji:${{ secrets.DAGSHUB_TOKEN }}" \
              -o models/random_forest/Production/model.pkl \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/44/bebd223b998cf7e177aed1e73de3a6"
            curl -u "Alimiji:${{ secrets.DAGSHUB_TOKEN }}" \
              -o models/random_forest/Production/model_info.json \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/00/6851e7426c173879e57b2b91201121"
          fi

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYEOF'
          from huggingface_hub import HfApi, create_repo
          import os

          token = os.environ.get('HF_TOKEN')
          repo_id = 'Alimiji/weather-prediction-api'

          api = HfApi()

          # Create Space if it doesn't exist
          try:
              api.repo_info(repo_id=repo_id, repo_type='space', token=token)
              print(f"Space {repo_id} already exists")
          except Exception:
              print(f"Creating Space {repo_id}...")
              create_repo(
                  repo_id=repo_id,
                  repo_type='space',
                  space_sdk='docker',
                  token=token,
                  private=False
              )
              print(f"Space {repo_id} created!")

          # Upload files
          api.upload_folder(
              folder_path='.',
              repo_id=repo_id,
              repo_type='space',
              token=token,
              ignore_patterns=['*.git*', '__pycache__', '*.pyc', '.env', 'mlruns/*', 'data/*', 'docs/*', '.dvc/*', 'tests/*', 'notebooks/*']
          )
          print('Upload complete!')
          PYEOF

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to Hugging Face Spaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://huggingface.co/spaces/Alimiji/weather-prediction-api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Docs:** https://alimiji-weather-prediction-api.hf.space/docs" >> $GITHUB_STEP_SUMMARY
