name: Deploy to Hugging Face Spaces

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [master, main]
    types:
      - completed
  push:
    branches: [master, main]
    paths:
      - 'src/api/**'
      - 'Dockerfile'
      - 'requirements-api.txt'
  workflow_dispatch:

concurrency:
  group: hf-spaces-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Check HF token
        id: check_token
        run: |
          if [ -z "${{ secrets.HF_TOKEN }}" ]; then
            echo "::warning::HF_TOKEN secret not set. Please add it to deploy to Hugging Face Spaces."
            echo "Go to: https://huggingface.co/settings/tokens"
            echo "has_token=false" >> $GITHUB_OUTPUT
          else
            echo "has_token=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Hugging Face Spaces
        if: steps.check_token.outputs.has_token == 'true'
        uses: JacobLinCool/huggingface-sync@v1
        with:
          github: ${{ secrets.GITHUB_TOKEN }}
          token: ${{ secrets.HF_TOKEN }}
          user: Alimiji
          space: weather-prediction-api
          title: Weather Prediction API
          emoji: "ðŸŒ¤ï¸"
          colorFrom: blue
          colorTo: green
          sdk: docker

      - name: Deployment summary
        run: |
          echo "## Hugging Face Spaces Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** https://huggingface.co/spaces/Alimiji/weather-prediction-api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health: \`/health\`" >> $GITHUB_STEP_SUMMARY
          echo "- Predict: \`POST /predict\`" >> $GITHUB_STEP_SUMMARY
          echo "- Docs: \`/docs\`" >> $GITHUB_STEP_SUMMARY