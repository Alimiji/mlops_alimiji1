name: Deploy to Hugging Face Spaces

on:
  push:
    branches: [master, main]
    paths:
      - 'src/api/**'
      - 'Dockerfile'
      - 'requirements-api.txt'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install huggingface_hub dvc[s3]

      - name: Configure DVC with DagsHub
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          dvc remote modify dagshub --local auth basic
          dvc remote modify dagshub --local user Alimiji
          dvc remote modify dagshub --local password $DAGSHUB_TOKEN

      - name: Pull model from DVC
        run: |
          dvc pull models/random_forest/Production/model.pkl.dvc -v || echo "DVC pull failed, trying direct download"
          dvc pull models/random_forest/Production/model_info.json.dvc -v || true
          # Verify model exists
          if [ -f "models/random_forest/Production/model.pkl" ]; then
            echo "Model downloaded successfully"
            ls -la models/random_forest/Production/
          else
            echo "Model not found, downloading from DagsHub directly..."
            mkdir -p models/random_forest/Production
            curl -u "Alimiji:${{ secrets.DAGSHUB_TOKEN }}" \
              -o models/random_forest/Production/model.pkl \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/44/bebd223b998cf7e177aed1e73de3a6"
            curl -u "Alimiji:${{ secrets.DAGSHUB_TOKEN }}" \
              -o models/random_forest/Production/model_info.json \
              "https://dagshub.com/Alimiji/mlops_alimiji1.dvc/files/md5/00/6851e7426c173879e57b2b91201121"
          fi

      - name: Verify model files exist
        run: |
          echo "=== Checking model files ==="
          ls -la models/random_forest/Production/ || echo "Model directory not found!"
          if [ -f "models/random_forest/Production/model.pkl" ]; then
            echo "Model file exists: $(du -h models/random_forest/Production/model.pkl)"
          else
            echo "ERROR: Model file not found!"
            exit 1
          fi

      - name: Prepare HF Spaces README
        run: |
          cat > README.md << 'HFEOF'
---
title: Weather Prediction API
emoji: ðŸŒ¡ï¸
colorFrom: blue
colorTo: green
sdk: docker
pinned: false
license: mit
---

# Weather Temperature Prediction API

FastAPI-based ML API for predicting mean temperature.

## Endpoints
- GET /health - Health check
- POST /predict - Single prediction
- GET /metrics - Model metrics
- GET /docs - API documentation
HFEOF
          echo "=== README.md content ==="
          cat README.md
          echo "=== End README.md ==="

      - name: Push to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python << 'PYEOF'
          from huggingface_hub import HfApi, create_repo
          import os
          import sys

          token = os.environ.get('HF_TOKEN')
          if not token:
              print("ERROR: HF_TOKEN not set!")
              sys.exit(1)

          repo_id = 'Alimiji/weather-prediction-api'
          print(f"Token length: {len(token)} chars")
          print(f"Target repo: {repo_id}")

          api = HfApi()

          # Test token validity
          try:
              user_info = api.whoami(token=token)
              print(f"Authenticated as: {user_info.get('name', 'unknown')}")
          except Exception as e:
              print(f"ERROR: Token validation failed: {e}")
              sys.exit(1)

          # Create Space if it doesn't exist
          try:
              info = api.repo_info(repo_id=repo_id, repo_type='space', token=token)
              print(f"Space {repo_id} already exists (SDK: {info.cardData.get('sdk', 'unknown') if info.cardData else 'unknown'})")
          except Exception as e:
              print(f"Space not found ({e}), creating...")
              try:
                  create_repo(
                      repo_id=repo_id,
                      repo_type='space',
                      space_sdk='docker',
                      token=token,
                      private=False,
                      exist_ok=True
                  )
                  print(f"Space {repo_id} created successfully!")
              except Exception as create_err:
                  print(f"ERROR creating space: {create_err}")
                  sys.exit(1)

          # Upload files
          print("Uploading files to Space...")
          try:
              api.upload_folder(
                  folder_path='.',
                  repo_id=repo_id,
                  repo_type='space',
                  token=token,
                  ignore_patterns=['*.git*', '__pycache__', '*.pyc', '.env', 'mlruns/*', 'data/*', 'docs/*', '.dvc/*', 'tests/*', 'notebooks/*', 'streamlit_app/*']
              )
              print('Upload complete!')
          except Exception as upload_err:
              print(f"ERROR uploading: {upload_err}")
              sys.exit(1)
          PYEOF

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployed to Hugging Face Spaces" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://huggingface.co/spaces/Alimiji/weather-prediction-api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API Docs:** https://alimiji-weather-prediction-api.hf.space/docs" >> $GITHUB_STEP_SUMMARY
